{% extends "base.html" %}
{% block content %}
<div style="padding: 10px;">
    {{ fictionchapter.title }} -
    <a href="{% url 'fiction_fans:fiction_view' fictionchapter.fiction_title_id %}" style="margin-left: 10px;">
        {{ fictionchapter.fiction_title.title }}
    </a>
    <div style="float: right;">
        <a href="{% url 'fiction_fans:chapter_view' fictionchapter.fiction_title_id fictionchapter.id %}" style="margin-left: 10px; border: solid;">
            Previous Chapter
        </a>
        <a href="{% url 'fiction_fans:chapter_view' fictionchapter.fiction_title_id fictionchapter.id %}" style="margin-left: 10px; border: solid;">
            Next Chapter
        </a>
    </div>
</div>

<div style="border: solid; word-wrap: break-word; padding: 20px;">
    <section id="chapter-body"></section>
        <script>
            window.addEventListener(
                "DOMContentLoaded", () => {
                    const chapterBody = document.getElementById("chapter-body");
                    console.log("{{ fictionchapter.content | escapejs }}");
                    let body = JSON.parse("{{ fictionchapter.content | escapejs }}");
                    let block = body.blocks;
                    console.log(block.length);
                    for (let i = 0; i <= block.length; i++) {
                        console.log(block[i], i);
                        switch (block[i].type) {
                            case "Header":
                                let head = document.createElement(`h${block[i].data.level}`);
                                head.textContent = block[i].data.text;
                                chapterBody.appendChild(head);
                                break;
                            case "Image":
                                let div = document.createElement("div");
                                let image = document.createElement("img");
                                let caption = document.createElement("small");
                                image.src = `${block[i].data.file.url}`;
                                image.style = "margin-top:10px;";
                                image.height = 200;
                                image.width = 200;
                                caption.textContent = block[i].data.caption;
                                caption.style = "margin-top:5px;";
                                div.appendChild(image);
                                div.appendChild(caption);
                                div.style = "width:39%;display:grid;place-items:center";
                                chapterBody.appendChild(div);
                                break;
                            case "paragraph":
                                const text = document.createElement("p");
                                text.innerHTML = block[i].data.text;
                                chapterBody.appendChild(text);
                                break;
                            default:
                                break;
                        }
                    }
                }
            );
        </script>
</div>

<div style="float: right; margin: 10px;">
    <a href="{% url 'fiction_fans:chapter_edit' fictionchapter.fiction_title_id fictionchapter.id %}" style="margin-right: 10px; border: solid;">
        Edit
    </a>
    <a href="{% url 'fiction_fans:chapter_del' fictionchapter.fiction_title_id fictionchapter.id %}" style="border: solid;">
        Delete
    </a>
</div>

<div style="margin-top: 50px;">
    <form action="{% url 'fiction_fans:chapter_comment'  fictionchapter.fiction_title_id fictionchapter.id %}" method="post">
    {% csrf_token %}
        <fieldset style="padding: 20px;">
        <p>comment session</p>
        <textarea name="comment_text" id="comment_text" style="width: 800px; height: 100px;">
        </textarea>
        </fieldset>
        <div style="margin: 10px; float: right;">
            <input type="submit" value="comment" style="border: solid;">
        </div>
    </form>
</div>

<!-- comment display section. -->
<!-- will be change to user link -->
<div style="overflow: scroll; border: solid; padding: 20px; height: 300px; margin-top: 50px;">
    {% for comment in fictionchapter.comment_set.all %}    
        <h1 style="font-family: cursive; font-size: large; font-weight: 400; color: blueviolet;">
            {{ comment.user.get_username }}
        </h1>
        <p style="font-family: cursive; font-size: medium; font-weight: 200;">
            {{ comment.text }}
        </p>
        <date style="font-family: cursive; color: white; font-size: small; font-weight: 100;">
            {{ comment.comment_date }}
        </date>
    {% endfor %}
</div>
{% endblock content %}
